<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TuningHub Login</title>
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/login.css" />
       <link rel="stylesheet" href="/css/menu.css" />
    <link rel="stylesheet" href="/css/search.css" />
    <script src="/js/menu.js"></script>
    <script src="/js/search.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>

  <body>
    <header class="header">
      <div class="header-top">
        <div class="logo">
          <a href="../index.html">
            <img
              src="/img/THub-Logo-ohne-Hintergrund-500x200.png"
              alt="TuningHub Logo"
              height="50"
            />
          </a>
        </div>
        <div class="searchbar-wrapper">
        <input
          id="searchbar"
          type="text"
          class="searchbar"
          placeholder="Suche nach Teilen, Marken..."
        >
        <img 
        src="/svg/search_60dp_000000_FILL0_wght400_GRAD0_opsz48.svg"
        >
        
      </div>
      
  
      <button id="menu-btn" class="menu-button" aria-controls="sidebar" aria-expanded="false" aria-label="Navigation öffnen">
  <!-- Öffnene -->
  <img src="/svg/menu_60dp_000000_FILL0_wght400_GRAD0_opsz48.svg" alt="Menu" width="36" height="36" class="icon icon-open">
  <!-- Schließen -->
  <img src="/svg/close_60dp_000000_FILL0_wght400_GRAD0_opsz48.svg" alt="Schließen" width="36" height="36" class="icon icon-close">
</button>
<nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">Navigation</div>
        </div>
        <div class="menu-items">
            <a href="../index.html" class="menu-item">Startseite</a>
            <a href="#" class="menu-item" style="color: #999;">Benachrichtigungen</a>
            <a href="#" class="menu-item" style="color: #999;">Produkte</a>   
            <a href="datenschutz.html" class="menu-item">Datenschutz</a>          
            <a href="impressum.html" class="menu-item">Impressum</a>           
            <a href="übertuninghub.html" class="menu-item">Über uns</a>
            <a href="support.html" class="menu-item">Support</a>
            <a href="account.html" class="menu-item">Einstellungen</a>
        </div>
    </nav>
      <div class="overlay" id="overlay"></div>
    </header>
    <main>
      <h2 class="main-überschrift" id="form-title">Login</h2>
      <div class="form-wrapper">
        <form id="login-form" class="login-form">
          <input
            class="inputfield"
            id="email"
            type="email"
            placeholder="E-Mail"
            required
          />
          <br />
          <input
            class="inputfield"
            id="password"
            type="password"
            placeholder="Passwort"
            required
          />
          <br />
          <button type="submit">Einloggen</button>
          <a class="back-link" href="register.html">Registrieren</a>
          <a href="#" class="back-link" id="show-reset-form"
            >Passwort vergessen?</a
          >
          <p id="login-message"></p>
        </form>

        <form id="reset-form" class="reset-form">
          <input
            class="inputfield"
            id="reset-email"
            type="email"
            placeholder="E-Mail für Passwort-Reset"
            required
          />
          <br />
          <button type="submit">Reset-Link senden</button>
          <div class="form-toggle">
            <a href="#" id="show-login-form">Zurück zum Login</a>
          </div>
          <p id="reset-message"></p>
        </form>
      </div>
    </main>

    <footer>
      <div class="informations"><a href="übertuninghub.html">TuningHub</a></div>
      <div class="informations"><a href="impressum.html">Impressum</a></div>
      <div class="informations"><a href="support.html"> Support</a></div>
      <div class="informations">
        <a href="socialmedia.html"> Social Media</a>
      </div>
      <div class="informations"><a href="datenschutz.html">Datenschutz</a></div>
    </footer>

    <script>
      const trackingUrl = "https://lhxcnrogjjskgaclqxtm.supabase.co";
      const trackingKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxoeGNucm9nampza2dhY2xxeHRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MjU0MzUsImV4cCI6MjA2ODEwMTQzNX0.vOr_Esi9IIesFixkkvYQjYEqghrKCMeqbrPKW27zqww";

      const supabaseUrl = "https://yvdptnkmgfxkrszitweo.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2ZHB0bmttZ2Z4a3Jzeml0d2VvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3MDAwMzQsImV4cCI6MjA2NjI3NjAzNH0.Kd6D6IQ_stUMrcbm2TN-7ACjFJvXNmkeNehQHavTmJo";

      const trackingClient = supabase.createClient(trackingUrl, trackingKey);
      const client = supabase.createClient(supabaseUrl, supabaseKey);

      async function trackEvent(eventType, metadata = {}) {
        try {
          const { data, error } = await trackingClient
            .from("tracking_events")
            .insert({
              event_type: eventType,
              metadata: metadata,
            });

          if (error) {
            console.error("[Tracking] Supabase error:", error);
          } else {
            console.log("[Tracking] Event successfully tracked:", eventType);
          }
        } catch (err) {
          console.error("[Tracking] Unexpected error:", err);
        }
      }

      const loginForm = document.getElementById("login-form");
      const resetForm = document.getElementById("reset-form");
      const formTitle = document.getElementById("form-title");
      const loginMessage = document.getElementById("login-message");
      const resetMessage = document.getElementById("reset-message");
      const showResetForm = document.getElementById("show-reset-form");
      const showLoginForm = document.getElementById("show-login-form");

      function switchToResetForm() {
        loginForm.style.display = "none";
        resetForm.style.display = "block";
        formTitle.textContent = "Passwort zurücksetzen";
        loginMessage.textContent = "";
      }

      function switchToLoginForm() {
        resetForm.style.display = "none";
        loginForm.style.display = "block";
        formTitle.textContent = "Login";
        resetMessage.textContent = "";
      }

      showResetForm.addEventListener("click", (e) => {
        e.preventDefault();
        switchToResetForm();
        trackEvent("password_reset_form_opened");
      });

      showLoginForm.addEventListener("click", (e) => {
        e.preventDefault();
        switchToLoginForm();
      });

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;

        if (!email || !password) {
          loginMessage.style.color = "red";
          loginMessage.textContent = "Bitte fülle alle Felder aus.";
          await trackEvent("login_validation_error", {
            error: "missing_fields",
          });
          return;
        }

        loginMessage.style.color = "black";
        loginMessage.textContent = "Login wird durchgeführt...";

        try {
          await trackEvent("login_attempt", { email });

          const { data, error } = await client.auth.signInWithPassword({
            email,
            password,
          });

          if (error) {
            if (error.message.includes("Email not confirmed")) {
              loginMessage.style.color = "orange";
              loginMessage.textContent =
                "Du musst zuerst deine E-Mail bestätigen. Schau in deinen Posteingang!";
              await trackEvent("login_success", { email });
              return;
            }

            throw error;
          }

          await trackEvent("login_success", {
            email: email,
            user_id: data.user?.id,
          });

          loginMessage.style.color = "green";
          loginMessage.textContent = "Login erfolgreich! Weiterleitung...";

          setTimeout(() => {
            window.location.href = "account.html";
          }, 2000);
        } catch (error) {
          console.error("Login-Fehler:", error);
          await trackEvent("login_error", {
            email: email,
            error_message: error.message,
            error_code: error.status || "unknown",
          });

          loginMessage.style.color = "red";
          loginMessage.textContent = "Fehler: " + error.message;
        }
      });

      resetForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const email = document.getElementById("reset-email").value.trim();

        if (!email) {
          resetMessage.style.color = "red";
          resetMessage.textContent = "Bitte gib deine E-Mail-Adresse ein.";
          return;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          resetMessage.style.color = "red";
          resetMessage.textContent =
            "Bitte gib eine gültige E-Mail-Adresse ein.";
          return;
        }

        resetMessage.style.color = "black";
        resetMessage.textContent = "Reset-Link wird gesendet...";

        try {
          await trackEvent("password_reset_attempt", { email });

          const { error } = await client.auth.resetPasswordForEmail(email, {
            redirectTo: `${window.location.origin}/reset-password.html`,
          });

          if (error) {
            throw error;
          }

          await trackEvent("password_reset_success", { email });

          resetMessage.style.color = "green";
          resetMessage.textContent =
            "Reset-Link wurde an deine E-Mail-Adresse gesendet. Bitte überprüfe deinen Posteingang!";

          document.getElementById("reset-email").value = "";

          setTimeout(() => {
            switchToLoginForm();
          }, 5000);
        } catch (error) {
          console.error("Password Reset Fehler:", error);
          await trackEvent("password_reset_error", {
            email: email,
            error_message: error.message,
            error_code: error.status || "unknown",
          });

          resetMessage.style.color = "red";
          resetMessage.textContent =
            "Fehler beim Senden des Reset-Links: " + error.message;
        }
      });

      document.addEventListener("DOMContentLoaded", function () {
        const emailInput = document.getElementById("email");
        const passwordInput = document.getElementById("password");
        const resetEmailInput = document.getElementById("reset-email");

        function validateInputs() {
          loginMessage.textContent = "";

          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (emailInput.value && !emailRegex.test(emailInput.value)) {
            emailInput.style.borderColor = "red";
          } else {
            emailInput.style.borderColor = "";
          }

          if (passwordInput.value && passwordInput.value.length < 6) {
            passwordInput.style.borderColor = "red";
          } else {
            passwordInput.style.borderColor = "";
          }
        }

        function validateResetEmail() {
          resetMessage.textContent = "";

          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (
            resetEmailInput.value &&
            !emailRegex.test(resetEmailInput.value)
          ) {
            resetEmailInput.style.borderColor = "red";
          } else {
            resetEmailInput.style.borderColor = "";
          }
        }

        emailInput.addEventListener("input", validateInputs);
        passwordInput.addEventListener("input", validateInputs);
        emailInput.addEventListener("blur", validateInputs);
        passwordInput.addEventListener("blur", validateInputs);

        resetEmailInput.addEventListener("input", validateResetEmail);
        resetEmailInput.addEventListener("blur", validateResetEmail);
      });
    </script>
  </body>
</html>
