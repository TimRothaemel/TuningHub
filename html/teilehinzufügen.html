<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="format-detection" content="telephone=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Teil hinzufügen – TuningHub</title>
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/teilehinzufügen.css" />
  <style>
    .image-upload-container {
      margin-bottom: 15px;
    }
    
    .image-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    
    .image-preview {
      position: relative;
      width: 100px;
      height: 100px;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .remove-image {
      position: absolute;
      top: 0;
      right: 0;
      background: rgba(255, 0, 0, 0.7);
      color: white;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 0 0 0 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .add-image-btn {
      background-color: #f0f0f0;
      color: #333;
      border: 1px dashed #ccc;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
      display: inline-block;
    }
    
    .add-image-btn:hover {
      background-color: #e0e0e0;
    }
    
    .image-input-wrapper {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div>Wird verarbeitet...</div>
  </div>

  <header class="header">
    <div class="header-top">
      <div class="logo">
        <a href="../index.html">
          <img src="/img/THub-Logo-ohne-Hintergrund-500x200.png" alt="TuningHub Logo" height="50" />
        </a>
      </div>
      <div class="account-erstellen">
        <a id="account-link" href="account.html" title="Mein Account">
          <img src="/img/account_circle_dark.png" alt="Account" width="36" height="36" />
        </a>
      </div>
    </div>
  </header>
  
  <main>
    <section id="teile-hinzufuegen">
      <h2>Teil hinzufügen</h2>

      <div class="link-bar">
        <a href="teilesuchen.html">Teilsuche hinzufügen</a>
      </div>
     
      <div id="success-message" class="success-message"></div>
      <div id="error-message" class="error-message"></div>
      
      <label for="partTitle">Titel</label>
      <input type="text" id="partTitle" placeholder="z. B. Auspuff S51" required maxlength="100" />
      
      <label for="partDescription">Beschreibung</label>
      <textarea id="partDescription" placeholder="Beschreibe das Teil..." rows="4" required maxlength="1000"></textarea>
      
      <label for="partPrice">Preis (in €)</label>
      <input type="number" id="partPrice" placeholder="z. B. 49.99" step="0.01" min="0" max="99999" required />
      
      <label for="partCondition">Zustand</label>
      <select id="partCondition" required>
        <option value="">Bitte wählen...</option>
        <option value="neu">Neu</option>
        <option value="sehr gut">Sehr gut</option>
        <option value="gebraucht">Gebraucht</option>
        <option value="defekt">Defekt / Bastler</option>
      </select>
      
      <div class="image-upload-container">
        <label>Bilder auswählen (max. 5)</label>
        <div id="imageInputsContainer">
          <div class="image-input-wrapper">
            <input type="file" 
                   class="partImage"
                   accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" 
                   data-index="0"
                   required />
          </div>
        </div>
        
        <div id="imagePreviews" class="image-preview-container"></div>
        
  
      <input type="hidden" id="partType" value="teil" />
      
      <label class="telefonlabel">Telefonnummer</label>
      <div class="phone-wrapper">
        <span id="userPhoneNumber">Lade...</span>
        <div class="phone-dropdown">
          <a href="account.html">Nummer ändern</a>
        </div>
      </div>
      
      <button id="addPartBtn" type="button">Teil hinzufügen</button>
    </section> 
  </main>
  
  <footer>
    <div class="informations"><a href="übertuninghub.html">TuningHub</a></div>
    <div class="informations"><a href="impressum.html">Impressum</a></div>
    <div class="informations"><a href="support.html">Support</a></div>
    <div class="informations"><a href="socialmedia.html">Social Media</a></div>
    <div class="informations"><a href="datenschutz.html">Datenschutz</a></div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    'use strict';

    let supabase = null;
    let trackingSupabase = null;
    let userPhone = '';
    let currentUser = null;
    let isProcessing = false;
    let imageInputCount = 1; 


    function initializeSupabase() {
      try {
      
        supabase = window.supabase.createClient(
          'https://yvdptnkmgfxkrszitweo.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2ZHB0bmttZ2Z4a3Jzeml0d2VvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3MDAwMzQsImV4cCI6MjA2NjI3NjAzNH0.Kd6D6IQ_stUMrcbm2TN-7ACjFJvXNmkeNehQHavTmJo',
          {
            auth: {
              autoRefreshToken: true,
              persistSession: true,
              detectSessionInUrl: true,
            },
          }
        );

       
        trackingSupabase = window.supabase.createClient(
          'https://lhxcnrogjjskgaclqxtm.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxoeGNucm9nampza2dhY2xxeHRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MjU0MzUsImV4cCI6MjA2ODEwMTQzNX0.vOr_Esi9IIesFixkkvYQjYEqghrKCMeqbrPKW27zqww',
          {
            auth: {
              autoRefreshToken: false,
              persistSession: false
            }
          }
        );

        console.log('Supabase erfolgreich initialisiert');
        return true;
      } catch (error) {
        console.error('Fehler bei Supabase-Initialisierung:', error);
        showError('Verbindungsfehler. Bitte Seite neu laden.');
        return false;
      }
    }

   
    function showLoading(show = true) {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.classList.toggle('show', show);
      }
    }

   
    async function getCurrentUser() {
      try {
        if (!supabase) {
          throw new Error('Supabase nicht initialisiert');
        }

        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error) {
          console.error('Session-Fehler:', error);
          throw error;
        }
        
        if (!session || !session.user) {
          showError("Du musst eingeloggt sein, um ein Teil hinzuzufügen.");
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);
          return null;
        }
        
        return session.user;
      } catch (error) {
        console.error('Fehler beim Abrufen des Benutzers:', error);
        showError('Fehler bei der Authentifizierung. Bitte neu einloggen.');
        return null;
      }
    }

    
    async function loadPhoneNumber() {
      try {
        currentUser = await getCurrentUser();
        if (!currentUser) return;

        const phoneDisplay = document.getElementById('userPhoneNumber');
        if (!phoneDisplay) return;

       
        if (currentUser.user_metadata?.phone) {
          userPhone = currentUser.user_metadata.phone;
          phoneDisplay.textContent = userPhone;
          return;
        }

       
        const { data, error } = await supabase
          .from('profiles')
          .select('phone_number')
          .eq('id', currentUser.id)
          .single();

        if (error) {
          console.error('Fehler beim Laden der Telefonnummer:', error);
          phoneDisplay.textContent = 'Keine Nummer gefunden';
          userPhone = '';
          return;
        }

        if (data && data.phone_number) {
          userPhone = data.phone_number;
          phoneDisplay.textContent = userPhone;
        } else {
          phoneDisplay.textContent = 'Keine Nummer gefunden';
          userPhone = '';
        }
      } catch (error) {
        console.error('Unerwarteter Fehler beim Laden der Telefonnummer:', error);
        const phoneDisplay = document.getElementById('userPhoneNumber');
        if (phoneDisplay) {
          phoneDisplay.textContent = 'Fehler beim Laden';
        }
      }
    }

    
    function showSuccess(message) {
      hideMessages();
      const successDiv = document.getElementById('success-message');
      if (successDiv) {
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        
        setTimeout(() => {
          successDiv.style.display = 'none';
        }, 5000);
      }
    }

    
    function showError(message) {
      hideMessages();
      const errorDiv = document.getElementById('error-message');
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
      }
    }

   
    function hideMessages() {
      const successDiv = document.getElementById('success-message');
      const errorDiv = document.getElementById('error-message');
      
      if (successDiv) successDiv.style.display = 'none';
      if (errorDiv) errorDiv.style.display = 'none';
    }

   
    function resetForm() {
      const elements = ['partTitle', 'partDescription', 'partPrice', 'partCondition'];
      elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          if (element.type === 'select-one') {
            element.selectedIndex = 0;
          } else {
            element.value = '';
          }
        }
      });
      
    
      const imageInputs = document.querySelectorAll('.partImage');
      imageInputs.forEach(input => {
        input.value = '';
      });
      
    
      document.getElementById('imagePreviews').innerHTML = '';
      
    
      const container = document.getElementById('imageInputsContainer');
      while (container.children.length > 1) {
        container.removeChild(container.lastChild);
      }
      
     
      imageInputCount = 1;
      
     
      if (container.firstChild) {
        container.firstChild.querySelector('.partImage').required = true;
      }
    }

   
    async function compressImage(file, maxWidth = 800, maxHeight = 800, quality = 0.85) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = function(event) {
          const img = new Image();
          img.onload = function() {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

           
            if (width > maxWidth || height > maxHeight) {
              const ratio = Math.min(maxWidth / width, maxHeight / height);
              width = Math.floor(width * ratio);
              height = Math.floor(height * ratio);
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');

          
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob((blob) => {
              resolve(new File([blob], file.name, {
                type: 'image/jpeg',
                lastModified: Date.now()
              }));
            }, 'image/jpeg', quality);
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    function createImagePreview(file, index) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const previewContainer = document.getElementById('imagePreviews');
        const previewDiv = document.createElement('div');
        previewDiv.className = 'image-preview';
        previewDiv.dataset.index = index;
        
        previewDiv.innerHTML = `
          <img src="${e.target.result}" alt="Vorschau">
          <button type="button" class="remove-image" data-index="${index}">×</button>
        `;
        
        previewContainer.appendChild(previewDiv);
        
        previewDiv.querySelector('.remove-image').addEventListener('click', function() {
          removeImageInput(index);
        });
      };
      reader.readAsDataURL(file);
    }

    function removeImageInput(index) {

      const inputWrapper = document.querySelector(`.partImage[data-index="${index}"]`).closest('.image-input-wrapper');
      if (inputWrapper) {
        inputWrapper.remove();
      }
      
      const preview = document.querySelector(`.image-preview[data-index="${index}"]`);
      if (preview) {
        preview.remove();
      }
      
      const inputs = document.querySelectorAll('.partImage');
      if (inputs.length === 0) {
        addImageInput();
      }
    }

    function addImageInput() {
      if (imageInputCount >= 5) {
        showError('Maximal 5 Bilder sind erlaubt.');
        return;
      }
      
      const container = document.getElementById('imageInputsContainer');
      const newIndex = imageInputCount;
      
      const wrapper = document.createElement('div');
      wrapper.className = 'image-input-wrapper';
      wrapper.innerHTML = `
        <input type="file" 
               class="partImage"
               accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" 
               data-index="${newIndex}" />
      `;
      
      container.appendChild(wrapper);
      
      const newInput = wrapper.querySelector('.partImage');
      newInput.addEventListener('change', function(e) {
        handleImageSelection(e, newIndex);
      });
      
      imageInputCount++;
      
      if (imageInputCount >= 5) {
        document.getElementById('addImageBtn').style.display = 'none';
      }
    }

    function handleImageSelection(e, index) {
      const file = e.target.files?.[0];
      if (!file) return;
      
      const maxSize = 10 * 1024 * 1024; 
      if (file.size > maxSize) {
        showError('Das ausgewählte Bild ist zu groß (max. 10MB).');
        e.target.value = '';
        return;
      }
      
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
      if (!allowedTypes.includes(file.type.toLowerCase())) {
        showError('Nur Bilddateien (JPEG, PNG, GIF, WebP) sind erlaubt.');
        e.target.value = '';
        return;
      }
      
      hideMessages();
      
      
      createImagePreview(file, index);
      
      
      if (imageInputCount < 5) {
        addImageInput();
      }
    }


    function validateInputs() {
      const title = document.getElementById("partTitle")?.value?.trim() || '';
      const description = document.getElementById("partDescription")?.value?.trim() || '';
      const priceInput = document.getElementById("partPrice")?.value?.trim() || '';
      const condition = document.getElementById("partCondition")?.value || '';
      const type = document.getElementById("partType")?.value || 'teil';

      
      if (!title) {
        throw new Error("Bitte gib einen Titel ein.");
      }
      if (title.length > 100) {
        throw new Error("Der Titel ist zu lang (max. 100 Zeichen).");
      }

      
      if (!description) {
        throw new Error("Bitte gib eine Beschreibung ein.");
      }
      if (description.length > 1000) {
        throw new Error("Die Beschreibung ist zu lang (max. 1000 Zeichen).");
      }


      const price = parseFloat(priceInput);
      if (!priceInput || isNaN(price) || price < 0) {
        throw new Error("Bitte gib einen gültigen Preis ein.");
      }
      if (price > 99999) {
        throw new Error("Der Preis ist zu hoch (max. 99.999€).");
      }


      if (!condition) {
        throw new Error("Bitte wähle einen Zustand aus.");
      }


      const imageInputs = document.querySelectorAll('.partImage');
      let hasImage = false;
      const imageFiles = [];
      
      for (const input of imageInputs) {
        if (input.files && input.files[0]) {
          hasImage = true;
          const file = input.files[0];
          

          const maxFileSize = 10 * 1024 * 1024;
          if (file.size > maxFileSize) {
            throw new Error(`Das Bild "${file.name}" ist zu groß. Maximal 10MB sind erlaubt.`);
          }

          const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
          if (!allowedTypes.includes(file.type.toLowerCase())) {
            throw new Error(`Nur Bilder (JPEG, PNG, GIF, WebP) sind erlaubt. "${file.name}" ist kein unterstütztes Format.`);
          }
          
          imageFiles.push(file);
        }
      }
      
      if (!hasImage) {
        throw new Error("Bitte wähle mindestens ein Bild aus.");
      }


      if (!userPhone) {
        throw new Error("Telefonnummer nicht gefunden. Bitte aktualisiere deine Kontaktdaten in den Einstellungen.");
      }

      return {
        title,
        description,
        price,
        condition,
        imageFiles,
        type
      };
    }


    async function trackEvent(eventType, metadata = {}) {
      try {
        if (!trackingSupabase || !currentUser) return;
        
        const { error } = await trackingSupabase
          .from('tracking_events')
          .insert([{
            event_type: eventType,
            user_id: currentUser.id,
            metadata: {
              ...metadata,
              timestamp: new Date().toISOString(),
              user_agent: navigator.userAgent,
              platform: navigator.platform
            }
          }]);
        
        if (error) {
          console.error('Tracking-Fehler:', error);
        }
      } catch (err) {
        console.error('Tracking-Exception:', err);
      }
    }

  
    async function addPart() {

      if (isProcessing) {
        console.log('Verarbeitung bereits im Gange...');
        return;
      }

      const button = document.getElementById('addPartBtn');
      
      try {
        isProcessing = true;
        
 
        if (button) {
          button.disabled = true;
          button.textContent = 'Wird gespeichert...';
        }
        showLoading(true);
        hideMessages();

        console.log('Starte Teil-Hinzufügung...');

    
        const user = await getCurrentUser();
        if (!user) {
          throw new Error('Benutzer nicht authentifiziert');
        }
        currentUser = user;


        const validatedData = validateInputs();
        console.log('Validierung erfolgreich');


        console.log('Starte Bildkomprimierung...');
        const compressedImages = [];
        for (const file of validatedData.imageFiles) {
          const compressedImage = await compressImage(file);
          compressedImages.push(compressedImage);
          console.log('Bild erfolgreich komprimiert', {
            originalSize: file.size,
            compressedSize: compressedImage.size,
            reduction: `${Math.round((1 - compressedImage.size / file.size) * 100)}%`
          });
        }

        const imageUrls = [];
        const uploadedFileNames = [];
        

        for (let i = 0; i < compressedImages.length; i++) {
          const compressedImage = compressedImages[i];
          

          const timestamp = Date.now();
          const randomString = Math.random().toString(36).substring(2, 8);
          const fileName = `${user.id}_${timestamp}_${randomString}_${i}.jpg`;

          console.log(`Starte Bild-Upload ${i+1}:`, fileName);


          const { data: uploadData, error: uploadError } = await supabase.storage
            .from('parts-images')
            .upload(fileName, compressedImage, {
              cacheControl: '3600',
              upsert: false,
              contentType: 'image/jpeg',
            });

          if (uploadError) {
            console.error('Upload-Fehler:', uploadError);
            
            if (uploadedFileNames.length > 0) {
              try {
                await supabase.storage
                  .from('parts-images')
                  .remove(uploadedFileNames);
              } catch (cleanupError) {
                console.error('Cleanup-Fehler nach Upload-Fehler:', cleanupError);
              }
            }
            
            throw new Error(`Fehler beim Hochladen des Bildes: ${uploadError.message}`);
          }

          console.log(`Bild-Upload ${i+1} erfolgreich`);
          
          const imageUrl = `https://yvdptnkmgfxkrszitweo.supabase.co/storage/v1/object/public/parts-images/${fileName}`;
          imageUrls.push(imageUrl);
          uploadedFileNames.push(fileName);
        }

        console.log('Alle Bilder erfolgreich hochgeladen');

        const insertData = {
          user_id: user.id,
          title: validatedData.title,
          description: validatedData.description,
          price: validatedData.price,
          condition: validatedData.condition,
          contact_number: userPhone,
          type: validatedData.type,
          created_at: new Date().toISOString()
        };
        
        for (let i = 0; i < Math.min(imageUrls.length, 5); i++) {
          const fieldName = i === 0 ? 'image_url' : `image_url${i+1}`;
          insertData[fieldName] = imageUrls[i];
        }

        console.log('Starte Datenbank-Insert');

        const { data: result, error: insertError } = await supabase
          .from('parts')
          .insert([insertData])
          .select();

        if (insertError) {
          console.error('Insert-Fehler:', insertError);
          
          try {
            await supabase.storage
              .from('parts-images')
              .remove(uploadedFileNames);
          } catch (cleanupError) {
            console.error('Cleanup-Fehler:', cleanupError);
          }
          
          throw new Error(`Fehler beim Speichern: ${insertError.message}`);
        }

        console.log('Teil erfolgreich gespeichert');

        await trackEvent('teil_hinzugefuegt', {
          title: validatedData.title,
          price: validatedData.price,
          condition: validatedData.condition,
          type: validatedData.type,
          image_count: validatedData.imageFiles.length,
          success: true
        });

        showLoading(false);
        showSuccess("Teil erfolgreich hinzugefügt! Du wirst zur Startseite weitergeleitet...");
        resetForm();

        setTimeout(() => {
          window.location.href = '../index.html';
        }, 2000);

      } catch (error) {
        console.error('Fehler beim Hinzufügen des Teils:', error);
        showLoading(false);
        showError(error.message || 'Ein unerwarteter Fehler ist aufgetreten. Bitte versuche es erneut.');
        
        await trackEvent('teil_hinzufuegen_fehler', {
          error: error.message,
          success: false
        });
        
      } finally {
        isProcessing = false;
        
        if (button) {
          button.disabled = false;
          button.textContent = 'Teil hinzufügen';
        }
        showLoading(false);
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM geladen, initialisiere App...');
      
      if (!initializeSupabase()) {
        return;
      }

      loadPhoneNumber();

      const addButton = document.getElementById('addPartBtn');
      if (addButton) {
        addButton.addEventListener('click', addPart);
      }

      const addImageBtn = document.getElementById('addImageBtn');
      if (addImageBtn) {
        addImageBtn.addEventListener('click', addImageInput);
      }
      const firstImageInput = document.querySelector('.partImage[data-index="0"]');
      if (firstImageInput) {
        firstImageInput.addEventListener('change', function(e) {
          handleImageSelection(e, 0);
        });
      }

      const inputs = ['partTitle', 'partDescription', 'partPrice'];
      inputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', hideMessages);
        }
      });

      console.log('App erfolgreich initialisiert');
    });

    window.addEventListener('error', function(e) {
      console.error('Globaler Fehler:', e.error);
      showError('Ein unerwarteter Fehler ist aufgetreten. Bitte lade die Seite neu.');
    });

    window.addEventListener('unhandledrejection', function(e) {
      console.error('Unbehandelte Promise-Ablehnung:', e.reason);
      showError('Ein Netzwerkfehler ist aufgetreten. Bitte versuche es erneut.');
    });
  </script>
</body>
</html>