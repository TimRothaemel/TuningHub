<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meine Teile TuningHub</title>
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/meineteile.css" />
    <link rel="stylesheet" href="/css/card.css">
       <link rel="stylesheet" href="/css/menu.css" />
    <link rel="stylesheet" href="/css/search.css" />
    <script src="/js/menu.js"></script>
    <script src="/js/search.js"></script>
    <style>
      main {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
        width: 100%;
      }

      h2 {
        margin: 20px 0;
        color: #333;
        font-size: 1.8rem;
        padding: 0 24px;
      }

      .empty-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 2rem;
        background: white;
        border-radius: 12px;
        border: 1px solid #ddd;
        color: #666;
        font-size: 1.1rem;
      }

      .empty-state a {
        color: #0077cc;
        text-decoration: none;
      }

      .empty-state a:hover {
        text-decoration: underline;
      }

      /* Detail Modal Styles - Diese fehlten! */
      .detail-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        z-index: 1000;
        overflow-y: auto;
      }

      .detail-modal.active {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 20px;
      }

      .detail-content {
        background: white;
        border-radius: 12px;
        max-width: 900px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
      }

      .detail-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
      }

      .detail-title {
        margin: 0;
        font-size: 1.5rem;
        color: #333;
      }

      .close-button {
        background: none;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        color: #666;
        padding: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s ease;
      }

      .close-button:hover {
        background-color: #f5f5f5;
      }

      .detail-body {
        padding: 20px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }

      .detail-image-section {
        position: relative;
        overflow: hidden;
        border-radius: 12px;
        background: #f8f9fa;
        min-height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .detail-main-image {
        max-width: 100%;
        max-height: 400px;
        object-fit: contain;
        transition: opacity 0.3s ease;
      }

      .detail-info-section {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .detail-price {
        font-size: 2rem;
        font-weight: bold;
        color: #2c3e50;
        margin: 0;
      }

      .detail-description {
        font-size: 1rem;
        line-height: 1.6;
        color: #555;
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
      }

      .detail-meta {
        display: grid;
        gap: 12px;
      }

      .meta-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }

      .meta-label {
        font-weight: 600;
        color: #666;
      }

      .meta-value {
        color: #333;
      }

      .detail-actions {
        display: flex;
        gap: 12px;
        margin-top: 20px;
      }

      .action-button {
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .primary-button {
        background: #007bff;
        color: white;
      }

      .primary-button:hover {
        background: #0056b3;
      }

      .secondary-button {
        background: #f8f9fa;
        color: #333;
        border: 1px solid #ddd;
      }

      .secondary-button:hover {
        background: #e9ecef;
      }

      .contact-dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .contact-dialog-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .contact-phone {
        font-size: 20px;
        font-weight: bold;
        color: #333;
        margin: 15px 0 25px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .contact-options {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .contact-option {
        flex: 1;
        min-width: 100px;
        padding: 15px 10px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      .contact-option.call {
        background: #28a745;
        color: white;
      }

      .contact-option.call:hover {
        background: #218838;
        transform: translateY(-2px);
      }

      .contact-option.whatsapp {
        background: #25d366;
        color: white;
      }

      .contact-option.whatsapp:hover {
        background: #1ebe5c;
        transform: translateY(-2px);
      }

      .contact-option.sms {
        background: #007bff;
        color: white;
      }

      .contact-option.sms:hover {
        background: #0056b3;
        transform: translateY(-2px);
      }

      .contact-option .icon {
        font-size: 24px;
      }

      .contact-cancel {
        padding: 12px 30px;
        border: 2px solid #ddd;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        color: #666;
        transition: all 0.2s ease;
      }

      .contact-cancel:hover {
        border-color: #999;
        color: #333;
      }

      .loading,
      .error,
      .empty {
        text-align: center;
        padding: 40px 20px;
        font-size: 18px;
        color: #666;
      }

      .error {
        color: #dc3545;
      }

      /* Card Actions Styles */
      .card-actions {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      .delete-btn {
        padding: 8px 16px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      .delete-btn:hover {
        background: #c82333;
        transform: translateY(-1px);
      }

      @media (max-width: 768px) {
        .detail-body {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .contact-options {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-top">
        <div class="logo">
          <a href="../index.html">
            <img
              src="/img/THub-Logo-ohne-Hintergrund-500x200.png"
              alt="TuningHub Logo"
              height="50"
            />
          </a>
        </div>
        <div class="searchbar-wrapper">
        <input
          id="searchbar"
          type="text"
          class="searchbar"
          placeholder="Suche nach Teilen, Marken..."
        >
        <img 
        src="/svg/search_60dp_000000_FILL0_wght400_GRAD0_opsz48.svg"
        >
        
      </div>
      
  
      <button id="menu-btn" class="menu-button" aria-controls="sidebar" aria-expanded="false" aria-label="Navigation öffnen">
  <!-- Öffnene -->
  <img src="/svg/menu_60dp_000000_FILL0_wght400_GRAD0_opsz48.svg" alt="Menu" width="36" height="36" class="icon icon-open">
  <!-- Schließen -->
  <img src="/svg/close_60dp_000000_FILL0_wght400_GRAD0_opsz48.svg" alt="Schließen" width="36" height="36" class="icon icon-close">
</button>
<nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">Navigation</div>
        </div>
               <div class="menu-items">
            <a href="../index.html" class="menu-item">Startseite</a>
            <a href="teilehinzufügen.html" class="menu-item">Teile verkaufen</a>
            <a href="teilesuchen.html" class="menu-item">Teile suchen</a>
            <a href="#" class="menu-item" style="color: #999">Teile sofort verkaufen</a>
            <a href="#" class="menu-item" style="color: #999;">Benachrichtigungen</a>
            <a href="#" class="menu-item" style="color: #999;">Produkte</a>   
            <a href="datenschutz.html" class="menu-item">Datenschutz</a>          
            <a href="impressum.html" class="menu-item">Impressum</a>           
            <a href="übertuninghub.html" class="menu-item">Über uns</a>
            <a href="support.html" class="menu-item">Support</a>
            <a href="account.html" class="menu-item">Einstellungen</a>
        </div>
    </nav>
      <div class="overlay" id="overlay"></div>
    </header>

    <main>
      <h2>Meine Teile</h2>

      <div class="grid-container" id="angebot-container"></div>
    </main>

    <div class="detail-modal" id="detail-modal">
      <div class="detail-content">
        <div class="detail-header">
          <h1 class="detail-title" id="detail-title">Titel</h1>
          <button class="close-button" id="close-detail">&times;</button>
        </div>
        <div class="detail-body">
          <div class="detail-image-section">
            <img id="detail-image" class="detail-main-image" src="" alt="" />
          </div>
          <div class="detail-info-section">
            <p class="detail-price" id="detail-price">0€</p>
            <div class="detail-description" id="detail-description">
              Keine Beschreibung verfügbar.
            </div>
            <div class="detail-meta">
              <div class="meta-item">
                <span class="meta-label">Kategorie</span>
                <span class="meta-value" id="detail-category">Tuning-Teil</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">Zustand</span>
                <span class="meta-value" id="detail-condition">Gebraucht</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">Verkäufer</span>
                <span class="meta-value" id="detail-seller"
                  >Kontakt über Telefon</span
                >
              </div>
              <div class="meta-item">
                <span class="meta-label">Telefon</span>
                <span class="meta-value" id="detail-phone"
                  >Wird beim Kontakt angezeigt</span
                >
              </div>
            </div>
            <div class="detail-actions">
              <button
                class="action-button primary-button"
                id="contact-seller-btn"
              >
                Verkäufer kontaktieren
              </button>
              <button class="action-button secondary-button" id="share-btn">
                Teilen
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <div class="informations"><a href="übertuninghub.html">TuningHub</a></div>
      <div class="informations"><a href="impressum.html">Impressum</a></div>
      <div class="informations"><a href="support.html"> Support</a></div>
      <div class="informations">
        <a href="socialmedia.html"> Social Media</a>
      </div>
      <div class="informations"><a href="datenschutz.html">Datenschutz</a></div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      const supabaseUrl = "https://yvdptnkmgfxkrszitweo.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2ZHB0bmttZ2Z4a3Jzeml0d2VvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3MDAwMzQsImV4cCI6MjA2NjI3NjAzNH0.Kd6D6IQ_stUMrcbm2TN-7ACjFJvXNmkeNehQHavTmJo";

      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
      let currentUser = null;

      async function ladeAngebote() {
        const container = document.getElementById("angebot-container");
        container.innerHTML =
          '<div class="loading">🔄 Lade deine Teile...</div>';

        try {
          const {
            data: { user },
            error: userError,
          } = await supabase.auth.getUser();

          if (userError || !user) {
            window.location.href = "login.html";
            return;
          }

          currentUser = user;

          const { data: parts, error } = await supabase
            .from("parts")
            .select("*")
            .eq("user_id", user.id)
            .order("created_at", { ascending: false });

          if (error) throw error;

          if (!parts || parts.length === 0) {
            container.innerHTML = `
                        <div class="empty-state">
                            Du hast noch keine Teile hinzugefügt.<br><br>
                            <a href="teilehinzufügen.html">Jetzt Teil hinzufügen</a>
                        </div>
                    `;
            return;
          }

          container.innerHTML = "";
          parts.forEach((teil) => {
            const card = createCard(teil);
            container.appendChild(card);
          });
        } catch (error) {
          console.error("Fehler beim Laden der Teile:", error);
          container.innerHTML =
            '<div class="error">❌ Fehler beim Laden deiner Teile</div>';
        }
      }

      function createCard(teil) {
        const { name, preis, beschreibung, bild } = extractData(teil);

        const card = document.createElement("div");
        card.className = "card";

        const imageUrl =
          bild ||
          "https://via.placeholder.com/300x200/e9ecef/666?text=Kein+Bild";
        const fallbackUrl =
          "https://via.placeholder.com/300x200/f8f9fa/adb5bd?text=Bild+nicht+verfügbar";

        let preisText = preis;
        if (typeof preis === "number") {
          preisText = `${preis.toLocaleString("de-DE")}€`;
        } else if (typeof preis === "string" && !isNaN(parseFloat(preis))) {
          preisText = `${parseFloat(preis).toLocaleString("de-DE")}€`;
        }

        const kurzbeschreibung = truncateDescription(beschreibung, 120);

        card.innerHTML = `
                <img src="${imageUrl}" 
                     alt="${name}" 
                     onerror="this.src='${fallbackUrl}'" 
                     loading="lazy" />
                <div class="card-content">
                    <h2>${name}</h2>
                    ${kurzbeschreibung ? `<p class="card-description">${kurzbeschreibung}</p>` : ""}
                    <div class="card-footer">
                        <p><strong>${preisText}</strong></p>
                    </div>
                    <div class="card-actions">
                        <button class="delete-btn">Löschen</button>
                    </div>
                </div>
            `;

        card.addEventListener("click", function (e) {
          if (!e.target.closest(".delete-btn")) {
            openDetailView(teil);
          }
        });

        const deleteBtn = card.querySelector(".delete-btn");
        deleteBtn.addEventListener("click", async (e) => {
          e.stopPropagation();
          if (confirm("Möchten Sie dieses Teil wirklich löschen?")) {
            const { error } = await supabase
              .from("parts")
              .delete()
              .eq("id", teil.id);

            if (!error) {
              card.remove();
            } else {
              alert("Fehler beim Löschen des Teils");
            }
          }
        });

        return card;
      }

      function truncateDescription(text, maxLength = 120) {
        if (!text) return "";
        if (text.length <= maxLength) return text;
        return text.substr(0, maxLength).trim() + "...";
      }

      function extractData(teil) {
        const name =
          teil.name ||
          teil.title ||
          teil.bezeichnung ||
          teil.teil_name ||
          "Unbekanntes Teil";
        const preis =
          teil.preis ||
          teil.price ||
          teil.kosten ||
          teil.euro ||
          "Preis auf Anfrage";
        const beschreibung =
          teil.beschreibung || teil.description || teil.details || "";
        const bild =
          teil.bild_url || teil.image_url || teil.foto || teil.bild || null;
        const kategorie =
          teil.kategorie || teil.category || teil.type || "Tuning-Teil";
        const zustand =
          teil.zustand || teil.condition || teil.state || "Gebraucht";
        const telefon = teil.contact_number || teil.phone || teil.telefon || "";
        const verkäufer =
          teil.seller_name || teil.user_name || "Privater Verkäufer";
        const datum = teil.created_at || teil.date || new Date().toISOString();
        const id = teil.id;

        return {
          name,
          preis,
          beschreibung,
          bild,
          kategorie,
          zustand,
          telefon,
          verkäufer,
          datum,
          id,
        };
      }

      function openDetailView(teil) {
        const modal = document.getElementById("detail-modal");
        const {
          name,
          preis,
          beschreibung,
          bild,
          kategorie,
          zustand,
          telefon,
          verkäufer,
        } = extractData(teil);

        document.getElementById("detail-title").textContent = name;

        const imageUrl =
          bild ||
          "https://via.placeholder.com/600x400/e9ecef/666?text=Kein+Bild";
        const fallbackUrl =
          "https://via.placeholder.com/600x400/f8f9fa/adb5bd?text=Bild+nicht+verfügbar";
        const detailImage = document.getElementById("detail-image");
        detailImage.src = imageUrl;
        detailImage.alt = name;
        detailImage.onerror = function () {
          this.src = fallbackUrl;
        };

        let preisText = preis;
        if (typeof preis === "number") {
          preisText = `${preis.toLocaleString("de-DE")}€`;
        } else if (typeof preis === "string" && !isNaN(parseFloat(preis))) {
          preisText = `${parseFloat(preis).toLocaleString("de-DE")}€`;
        }
        document.getElementById("detail-price").textContent = preisText;

        document.getElementById("detail-description").textContent =
          beschreibung || "Keine detaillierte Beschreibung verfügbar.";

        document.getElementById("detail-category").textContent = kategorie;
        document.getElementById("detail-condition").textContent = zustand;
        document.getElementById("detail-seller").textContent = verkäufer;
        document.getElementById("detail-phone").textContent =
          telefon || "Nicht verfügbar";

        const contactBtn = document.getElementById("contact-seller-btn");
        contactBtn.onclick = function () {
          contactSeller(telefon);
        };

        if (!telefon) {
          contactBtn.disabled = true;
          contactBtn.textContent = "Keine Kontaktdaten verfügbar";
        } else {
          contactBtn.disabled = false;
          contactBtn.textContent = "Verkäufer kontaktieren";
        }

        const shareBtn = document.getElementById("share-btn");
        shareBtn.onclick = function () {
          sharePart(teil.id);
        };

        modal.classList.add("active");
        document.body.style.overflow = "hidden";
      }

      function closeDetailView() {
        const modal = document.getElementById("detail-modal");
        modal.classList.remove("active");
        document.body.style.overflow = "";
      }

      function contactSeller(telefon) {
        if (!telefon) {
          alert("Keine Telefonnummer verfügbar");
          return;
        }

        const cleanedPhone = telefon.replace(/[^\d+]/g, "");

        const dialog = document.createElement("div");
        dialog.className = "contact-dialog-overlay";
        dialog.innerHTML = `
                <div class="contact-dialog-content">
                    <h3>Kontaktoptionen</h3>
                    <p class="contact-phone">${telefon}</p>
                    <div class="contact-options">
                        <button class="contact-option call">
                            <span class="icon">📞</span>
                            <span>Anrufen</span>
                        </button>
                        <button class="contact-option whatsapp">
                            <span class="icon">💬</span>
                            <span>WhatsApp</span>
                        </button>
                        <button class="contact-option sms">
                            <span class="icon">📱</span>
                            <span>SMS</span>
                        </button>
                    </div>
                    <button class="contact-cancel">Abbrechen</button>
                </div>
            `;

        document.body.appendChild(dialog);

        dialog.querySelector(".call").addEventListener("click", () => {
          window.location.href = `tel:${cleanedPhone}`;
          dialog.remove();
        });

        dialog.querySelector(".whatsapp").addEventListener("click", () => {
          window.open(
            `https://wa.me/${cleanedPhone.replace(/[^\d]/g, "")}`,
            "_blank"
          );
          dialog.remove();
        });

        dialog.querySelector(".sms").addEventListener("click", () => {
          window.location.href = `sms:${cleanedPhone}`;
          dialog.remove();
        });

        dialog
          .querySelector(".contact-cancel")
          .addEventListener("click", () => {
            dialog.remove();
          });

        dialog.addEventListener("click", (e) => {
          if (e.target === dialog) {
            dialog.remove();
          }
        });
      }

      function sharePart(id) {
        const url = `${
          window.location.origin
        }../index.html?part=${encodeURIComponent(id)}`;

        if (navigator.share) {
          navigator
            .share({
              title: "Mein Tuning-Teil",
              text: "Schau dir dieses Teil bei TuningHub an!",
              url: url,
            })
            .catch((err) => console.warn("Sharing failed:", err));
        } else {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard
              .writeText(url)
              .then(() =>
                alert("Link zum Teil wurde in die Zwischenablage kopiert!")
              )
              .catch((err) => {
                console.error("Fehler beim Kopieren des Links:", err);
                fallbackCopyToClipboard(url);
              });
          } else {
            fallbackCopyToClipboard(url);
          }
        }
      }

      function fallbackCopyToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        textArea.style.top = "-999999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          const successful = document.execCommand("copy");
          if (successful) {
            alert("Link zum Teil wurde in die Zwischenablage kopiert!");
          } else {
            showLinkDialog(text);
          }
        } catch (err) {
          console.error("Fallback copy failed:", err);
          showLinkDialog(text);
        } finally {
          document.body.removeChild(textArea);
        }
      }

      function showLinkDialog(url) {
        const message = `Link konnte nicht automatisch kopiert werden. Bitte kopiere den Link manuell:\n\n${url}`;
        alert(message);
      }

      document.addEventListener("DOMContentLoaded", function () {
        document
          .getElementById("close-detail")
          .addEventListener("click", closeDetailView);
        document
          .getElementById("detail-modal")
          .addEventListener("click", function (e) {
            if (e.target === this) {
              closeDetailView();
            }
          });

        ladeAngebote();

        const accountLink = document.getElementById("account-link");
        if (accountLink) {
          accountLink.href = "account.html";
        }
      });
    </script>
  </body>
</html>