<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TuningHub - Passwort zurücksetzen</title>
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/reset-password.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
</head>

<body>
    <header class="header">
        <div class="header-top">
            <div class="logo">
                <a href="index.html">
                    <img src="img/THub-Logo-ohne-Hintergrund-500x200.png" alt="TuningHub Logo" height="50" />
                </a>
            </div>
            <div class="account-erstellen">
                <a id="account-link" href="login.html">
                    <img src="img/account-icon-schwarz.svg" alt="Account" width="36" height="36" />
                </a>
            </div>
        </div>
    </header>
    
    <main>
        <h2 class="main-überschrift">Neues Passwort festlegen</h2>
        
        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loading-spinner"></div>
        
        <!-- Reset Form -->
        <div class="form-wrapper" id="reset-form-container">
            <form id="reset-password-form">
                <input class="inputfield" id="new-password" type="password" placeholder="Neues Passwort" required>
                <input class="inputfield" id="confirm-password" type="password" placeholder="Passwort bestätigen" required>
                
                <div class="password-requirements">
                    <h4>Passwortanforderungen:</h4>
                    <ul>
                        <li id="length-req" class="invalid">Mindestens 8 Zeichen</li>
                        <li id="uppercase-req" class="invalid">Mindestens 1 Großbuchstabe</li>
                        <li id="lowercase-req" class="invalid">Mindestens 1 Kleinbuchstabe</li>
                        <li id="number-req" class="invalid">Mindestens 1 Zahl</li>
                        <li id="special-req" class="invalid">Mindestens 1 Sonderzeichen (!@#$%^&*(),.?":)</li>
                    </ul>
                </div>
                <div class="password-match" id="password-match"></div>
                
                <button type="submit" id="submit-btn" disabled>Passwort ändern</button>
                <a class="back-link" href="login.html">Zurück zum Login</a>
                <p id="message"></p>
            </form>
        </div>
        
        <!-- Success Container -->
        <div class="success-container" id="success-container">
            <h3>✓ Passwort erfolgreich geändert!</h3>
            <p>Ihr neues Passwort wurde erfolgreich gespeichert. Sie können sich jetzt mit Ihrem neuen Passwort anmelden.</p>
            <a href="login.html">Zum Login</a>
        </div>
        
       >
    </main>
    
    <footer>
        <div class="informations"><a href="übertuninghub.html">TuningHub</a> </div>
        <div class="informations"><a href="impressum.html">Impressum</a></div>
        <div class="informations"> <a href="support.html"> Support</a></div>
        <div class="informations"> <a href="socialmedia.html"> Social Media</a></div>
        <div class="informations"><a href="datenschutz.html">Datenschutz</a></div>
    </footer>
    
    <script>
        // Supabase Konfiguration
        const trackingUrl = 'https://lhxcnrogjjskgaclqxtm.supabase.co';
        const trackingKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxoeGNucm9nampza2dhY2xxeHRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MjU0MzUsImV4cCI6MjA2ODEwMTQzNX0.vOr_Esi9IIesFixkkvYQjYEqghrKCMeqbrPKW27zqww';

        const supabaseUrl = 'https://yvdptnkmgfxkrszitweo.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2ZHB0bmttZ2Z4a3Jzeml0d2VvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3MDAwMzQsImV4cCI6MjA2NjI3NjAzNH0.Kd6D6IQ_stUMrcbm2TN-7ACjFJvXNmkeNehQHavTmJo';

        // Clients erstellen
        const trackingClient = supabase.createClient(trackingUrl, trackingKey);
        const client = supabase.createClient(supabaseUrl, supabaseKey);

        // Tracking-Funktion
        async function trackEvent(eventType, metadata = {}) {
            try {
                const { data, error } = await trackingClient
                    .from('tracking_events')
                    .insert({
                        event_type: eventType,
                        metadata: metadata
                    });

                if (error) {
                    console.error('[Tracking] Supabase error:', error);
                } else {
                    console.log('[Tracking] Event successfully tracked:', eventType);
                }
            } catch (err) {
                console.error('[Tracking] Unexpected error:', err);
            }
        }

        // DOM Elements
        const loadingSpinner = document.getElementById('loading-spinner');
        const resetFormContainer = document.getElementById('reset-form-container');
        const successContainer = document.getElementById('success-container');
        const errorContainer = document.getElementById('error-container');
        const errorText = document.getElementById('error-text');
        const resetForm = document.getElementById('reset-password-form');
        const newPasswordInput = document.getElementById('new-password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const submitBtn = document.getElementById('submit-btn');
        const message = document.getElementById('message');

        // Password requirements elements
        const lengthReq = document.getElementById('length-req');
        const uppercaseReq = document.getElementById('uppercase-req');
        const lowercaseReq = document.getElementById('lowercase-req');
        const numberReq = document.getElementById('number-req');
        const specialReq = document.getElementById('special-req');
        const passwordMatch = document.getElementById('password-match');

        let accessToken = null;
        let refreshToken = null;

        // Parse URL parameters
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            
            return {
                access_token: urlParams.get('access_token') || hashParams.get('access_token'),
                refresh_token: urlParams.get('refresh_token') || hashParams.get('refresh_token'),
                type: urlParams.get('type') || hashParams.get('type'),
                error: urlParams.get('error') || hashParams.get('error'),
                error_description: urlParams.get('error_description') || hashParams.get('error_description')
            };
        }

        // Password validation functions
        function validatePassword(password) {
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
            };

            // Update UI
            lengthReq.className = requirements.length ? 'valid' : 'invalid';
            uppercaseReq.className = requirements.uppercase ? 'valid' : 'invalid';
            lowercaseReq.className = requirements.lowercase ? 'valid' : 'invalid';
            numberReq.className = requirements.number ? 'valid' : 'invalid';
            specialReq.className = requirements.special ? 'valid' : 'invalid';

            return Object.values(requirements).every(req => req);
        }

        function validatePasswordMatch() {
            const password = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (!confirmPassword) {
                passwordMatch.textContent = '';
                passwordMatch.className = 'password-match';
                return false;
            }

            if (password === confirmPassword) {
                passwordMatch.textContent = '✓ Passwörter stimmen überein';
                passwordMatch.className = 'password-match valid';
                return true;
            } else {
                passwordMatch.textContent = '❌ Passwörter stimmen nicht überein';
                passwordMatch.className = 'password-match invalid';
                return false;
            }
        }

        function updateSubmitButton() {
            const passwordValid = validatePassword(newPasswordInput.value);
            const passwordsMatch = validatePasswordMatch();
            
            submitBtn.disabled = !(passwordValid && passwordsMatch);
        }

        // Initialize page
        async function initializePage() {
            try {
                loadingSpinner.style.display = 'block';
                
                const params = getUrlParams();
                
                await trackEvent('password_reset_page_visited', { 
                    has_tokens: !!(params.access_token && params.refresh_token),
                    type: params.type,
                    error: params.error
                });

                // Check for errors in URL
                if (params.error) {
                    throw new Error(params.error_description || params.error);
                }

                // Check if we have the required tokens
                if (!params.access_token || !params.refresh_token || params.type !== 'recovery') {
                    throw new Error('Ungültiger oder fehlender Reset-Link');
                }

                accessToken = params.access_token;
                refreshToken = params.refresh_token;

                // Set the session with the tokens
                const { data, error } = await client.auth.setSession({
                    access_token: accessToken,
                    refresh_token: refreshToken
                });

                if (error) {
                    throw error;
                }

                // Session is valid, show the form
                loadingSpinner.style.display = 'none';
                resetFormContainer.style.display = 'block';

                await trackEvent('password_reset_session_valid');

            } catch (error) {
                console.error('Initialization error:', error);
                
                await trackEvent('password_reset_initialization_error', {
                    error_message: error.message
                });

                loadingSpinner.style.display = 'none';
                errorText.textContent = error.message || 'Der Reset-Link ist ungültig oder abgelaufen.';
                errorContainer.style.display = 'block';
            }
        }

        // Handle password reset
        resetForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (!validatePassword(newPassword)) {
                message.style.color = 'red';
                message.textContent = 'Das Passwort erfüllt nicht alle Anforderungen.';
                return;
            }

            if (newPassword !== confirmPassword) {
                message.style.color = 'red';
                message.textContent = 'Die Passwörter stimmen nicht überein.';
                return;
            }

            submitBtn.disabled = true;
            message.style.color = 'black';
            message.textContent = 'Passwort wird geändert...';

            try {
                await trackEvent('password_update_attempt');

                const { error } = await client.auth.updateUser({
                    password: newPassword
                });

                if (error) {
                    throw error;
                }

                await trackEvent('password_update_success');

                // Hide form and show success message
                resetFormContainer.style.display = 'none';
                successContainer.style.display = 'block';

                // Sign out user so they need to login with new password
                await client.auth.signOut();

            } catch (error) {
                console.error('Password update error:', error);
                
                await trackEvent('password_update_error', {
                    error_message: error.message,
                    error_code: error.status || 'unknown'
                });

                message.style.color = 'red';
                message.textContent = 'Fehler beim Ändern des Passworts: ' + error.message;
                submitBtn.disabled = false;
            }
        });

        // Event listeners for real-time validation
        newPasswordInput.addEventListener('input', () => {
            validatePassword(newPasswordInput.value);
            updateSubmitButton();
        });

        confirmPasswordInput.addEventListener('input', () => {
            updateSubmitButton();
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>