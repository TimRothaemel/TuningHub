<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="format-detection" content="telephone=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Teil hinzufügen – TuningHub</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/teilehinzufügen.css" />
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div>Wird verarbeitet...</div>
  </div>

  <header class="header">
    <div class="header-top">
      <div class="logo">
        <a href="index.html">
          <img src="img/THub-Logo-ohne-Hintergrund-500x200.png" alt="TuningHub Logo" height="50" />
        </a>
      </div>
      <div class="account-erstellen">
        <a id="account-link" href="account.html" title="Mein Account">
          <img src="img/account-icon-schwarz.svg" alt="Account" width="36" height="36" />
        </a>
      </div>
    </div>
  </header>
  
  <main>
    <section id="teile-hinzufuegen">
      <h2>Teil hinzufügen</h2>

      <div class="link-bar">
        <a href="teilesuchen.html">Teilsuche hinzufügen</a>
      </div>
     
      <div id="success-message" class="success-message"></div>
      <div id="error-message" class="error-message"></div>
      
      <label for="partTitle">Titel</label>
      <input type="text" id="partTitle" placeholder="z. B. Auspuff S51" required maxlength="100" />
      
      <label for="partDescription">Beschreibung</label>
      <textarea id="partDescription" placeholder="Beschreibe das Teil..." rows="4" required maxlength="1000"></textarea>
      
      <label for="partPrice">Preis (in €)</label>
      <input type="number" id="partPrice" placeholder="z. B. 49.99" step="0.01" min="0" max="99999" required />
      
      <label for="partCondition">Zustand</label>
      <select id="partCondition" required>
        <option value="">Bitte wählen...</option>
        <option value="neu">Neu</option>
        <option value="sehr gut">Sehr gut</option>
        <option value="gebraucht">Gebraucht</option>
        <option value="defekt">Defekt / Bastler</option>
      </select>
      
      <label for="partImage">Bild auswählen</label>
      <input type="file" 
             id="partImage" 
             accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" 
             required />
      <!-- Verstecktes Feld für den Teil-Typ -->
      <input type="hidden" id="partType" value="teil" />
      
      <label>Telefonnummer</label>
      <div class="phone-wrapper">
        <span id="userPhoneNumber">Lade...</span>
        <div class="phone-dropdown">
          <a href="account.html">Nummer ändern</a>
        </div>
      </div>
      
      <button id="addPartBtn" type="button">Teil hinzufügen</button>
    </section> 
  </main>
  
  <footer>
    <div class="informations"><a href="übertuninghub.html">TuningHub</a></div>
    <div class="informations"><a href="impressum.html">Impressum</a></div>
    <div class="informations"><a href="support.html">Support</a></div>
    <div class="informations"><a href="socialmedia.html">Social Media</a></div>
    <div class="informations"><a href="datenschutz.html">Datenschutz</a></div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    'use strict';

    // Globale Variablen
    let supabase = null;
    let trackingSupabase = null;
    let userPhone = '';
    let currentUser = null;
    let isProcessing = false;

    // Supabase-Initialisierung mit Fehlerbehandlung
    function initializeSupabase() {
      try {
        // Haupt-Supabase für Teile, Benutzer, etc.
        supabase = window.supabase.createClient(
          'https://yvdptnkmgfxkrszitweo.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2ZHB0bmttZ2Z4a3Jzeml0d2VvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3MDAwMzQsImV4cCI6MjA2NjI3NjAzNH0.Kd6D6IQ_stUMrcbm2TN-7ACjFJvXNmkeNehQHavTmJo',
          {
            auth: {
              autoRefreshToken: true,
              persistSession: true,
              detectSessionInUrl: true,
            },
          }
        );

        // Separate Supabase-Instanz für Tracking
        trackingSupabase = window.supabase.createClient(
          'https://lhxcnrogjjskgaclqxtm.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxoeGNucm9nampza2dhY2xxeHRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MjU0MzUsImV4cCI6MjA2ODEwMTQzNX0.vOr_Esi9IIesFixkkvYQjYEqghrKCMeqbrPKW27zqww',
          {
            auth: {
              autoRefreshToken: false,
              persistSession: false
            }
          }
        );

        console.log('Supabase erfolgreich initialisiert');
        return true;
      } catch (error) {
        console.error('Fehler bei Supabase-Initialisierung:', error);
        showError('Verbindungsfehler. Bitte Seite neu laden.');
        return false;
      }
    }

    // Loading-Overlay
    function showLoading(show = true) {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.classList.toggle('show', show);
      }
    }

    // Aktuellen Benutzer holen
    async function getCurrentUser() {
      try {
        if (!supabase) {
          throw new Error('Supabase nicht initialisiert');
        }

        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error) {
          console.error('Session-Fehler:', error);
          throw error;
        }
        
        if (!session || !session.user) {
          showError("Du musst eingeloggt sein, um ein Teil hinzuzufügen.");
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);
          return null;
        }
        
        return session.user;
      } catch (error) {
        console.error('Fehler beim Abrufen des Benutzers:', error);
        showError('Fehler bei der Authentifizierung. Bitte neu einloggen.');
        return null;
      }
    }

    // Telefonnummer laden
    async function loadPhoneNumber() {
      try {
        currentUser = await getCurrentUser();
        if (!currentUser) return;

        const phoneDisplay = document.getElementById('userPhoneNumber');
        if (!phoneDisplay) return;

        // Zuerst versuchen, aus user_metadata zu laden
        if (currentUser.user_metadata?.phone) {
          userPhone = currentUser.user_metadata.phone;
          phoneDisplay.textContent = userPhone;
          return;
        }

        // Dann aus der profiles Tabelle laden
        const { data, error } = await supabase
          .from('profiles')
          .select('phone_number')
          .eq('id', currentUser.id)
          .single();

        if (error) {
          console.error('Fehler beim Laden der Telefonnummer:', error);
          phoneDisplay.textContent = 'Keine Nummer gefunden';
          userPhone = '';
          return;
        }

        if (data && data.phone_number) {
          userPhone = data.phone_number;
          phoneDisplay.textContent = userPhone;
        } else {
          phoneDisplay.textContent = 'Keine Nummer gefunden';
          userPhone = '';
        }
      } catch (error) {
        console.error('Unerwarteter Fehler beim Laden der Telefonnummer:', error);
        const phoneDisplay = document.getElementById('userPhoneNumber');
        if (phoneDisplay) {
          phoneDisplay.textContent = 'Fehler beim Laden';
        }
      }
    }

    // Erfolgsnachricht anzeigen
    function showSuccess(message) {
      hideMessages();
      const successDiv = document.getElementById('success-message');
      if (successDiv) {
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        
        setTimeout(() => {
          successDiv.style.display = 'none';
        }, 5000);
      }
    }

    // Fehlernachricht anzeigen
    function showError(message) {
      hideMessages();
      const errorDiv = document.getElementById('error-message');
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
      }
    }

    // Nachrichten verstecken
    function hideMessages() {
      const successDiv = document.getElementById('success-message');
      const errorDiv = document.getElementById('error-message');
      
      if (successDiv) successDiv.style.display = 'none';
      if (errorDiv) errorDiv.style.display = 'none';
    }

    // Formular zurücksetzen
    function resetForm() {
      const elements = ['partTitle', 'partDescription', 'partPrice', 'partCondition', 'partImage'];
      elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          if (element.type === 'select-one') {
            element.selectedIndex = 0;
          } else {
            element.value = '';
          }
        }
      });
    }

    // Bildkomprimierungsfunktion
    async function compressImage(file, maxWidth = 800, maxHeight = 800, quality = 0.85) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = function(event) {
          const img = new Image();
          img.onload = function() {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            // Bildmaße anpassen, falls zu groß
            if (width > maxWidth || height > maxHeight) {
              const ratio = Math.min(maxWidth / width, maxHeight / height);
              width = Math.floor(width * ratio);
              height = Math.floor(height * ratio);
            }

            // Canvas mit neuen Maßen erstellen
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');

            // Hochwertige Bildskalierung
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(img, 0, 0, width, height);

            // In Blob umwandeln
            canvas.toBlob((blob) => {
              resolve(new File([blob], file.name, {
                type: 'image/jpeg',
                lastModified: Date.now()
              }));
            }, 'image/jpeg', quality);
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // Eingaben validieren
    function validateInputs() {
      const title = document.getElementById("partTitle")?.value?.trim() || '';
      const description = document.getElementById("partDescription")?.value?.trim() || '';
      const priceInput = document.getElementById("partPrice")?.value?.trim() || '';
      const condition = document.getElementById("partCondition")?.value || '';
      const fileInput = document.getElementById("partImage");
      const imageFile = fileInput?.files?.[0];
      const type = document.getElementById("partType")?.value || 'teil';

      // Titel prüfen
      if (!title) {
        throw new Error("Bitte gib einen Titel ein.");
      }
      if (title.length > 100) {
        throw new Error("Der Titel ist zu lang (max. 100 Zeichen).");
      }

      // Beschreibung prüfen
      if (!description) {
        throw new Error("Bitte gib eine Beschreibung ein.");
      }
      if (description.length > 1000) {
        throw new Error("Die Beschreibung ist zu lang (max. 1000 Zeichen).");
      }

      // Preis prüfen
      const price = parseFloat(priceInput);
      if (!priceInput || isNaN(price) || price < 0) {
        throw new Error("Bitte gib einen gültigen Preis ein.");
      }
      if (price > 99999) {
        throw new Error("Der Preis ist zu hoch (max. 99.999€).");
      }

      // Zustand prüfen
      if (!condition) {
        throw new Error("Bitte wähle einen Zustand aus.");
      }

      // Bild prüfen
      if (!imageFile) {
        throw new Error("Bitte wähle ein Bild aus.");
      }

      // Dateigröße prüfen (10MB)
      const maxFileSize = 10 * 1024 * 1024;
      if (imageFile.size > maxFileSize) {
        throw new Error("Das Bild ist zu groß. Maximal 10MB sind erlaubt.");
      }

      // Dateityp prüfen
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
      if (!allowedTypes.includes(imageFile.type.toLowerCase())) {
        throw new Error("Nur Bilder (JPEG, PNG, GIF, WebP) sind erlaubt.");
      }

      // Telefonnummer prüfen
      if (!userPhone) {
        throw new Error("Telefonnummer nicht gefunden. Bitte aktualisiere deine Kontaktdaten in den Einstellungen.");
      }

      return {
        title,
        description,
        price,
        condition,
        imageFile,
        type
      };
    }

    // Tracking-Event
    async function trackEvent(eventType, metadata = {}) {
      try {
        if (!trackingSupabase || !currentUser) return;
        
        const { error } = await trackingSupabase
          .from('tracking_events')
          .insert([{
            event_type: eventType,
            user_id: currentUser.id,
            metadata: {
              ...metadata,
              timestamp: new Date().toISOString(),
              user_agent: navigator.userAgent,
              platform: navigator.platform
            }
          }]);
        
        if (error) {
          console.error('Tracking-Fehler:', error);
        }
      } catch (err) {
        console.error('Tracking-Exception:', err);
      }
    }

    // Haupt-Funktion: Teil hinzufügen
    async function addPart() {
      // Doppelte Ausführung verhindern
      if (isProcessing) {
        console.log('Verarbeitung bereits im Gange...');
        return;
      }

      const button = document.getElementById('addPartBtn');
      
      try {
        isProcessing = true;
        
        // UI aktualisieren
        if (button) {
          button.disabled = true;
          button.textContent = 'Wird gespeichert...';
        }
        showLoading(true);
        hideMessages();

        console.log('Starte Teil-Hinzufügung...');

        // Benutzer prüfen
        const user = await getCurrentUser();
        if (!user) {
          throw new Error('Benutzer nicht authentifiziert');
        }
        currentUser = user;

        // Eingaben validieren
        const validatedData = validateInputs();
        console.log('Validierung erfolgreich');

        // Bild komprimieren
        console.log('Starte Bildkomprimierung...');
        const compressedImage = await compressImage(validatedData.imageFile);
        console.log('Bild erfolgreich komprimiert', {
          originalSize: validatedData.imageFile.size,
          compressedSize: compressedImage.size,
          reduction: `${Math.round((1 - compressedImage.size / validatedData.imageFile.size) * 100)}%`
        });

        // Eindeutigen Dateinamen generieren
        const timestamp = Date.now();
        const randomString = Math.random().toString(36).substring(2, 8);
        const fileName = `${user.id}_${timestamp}_${randomString}.jpg`; // Immer JPG nach Komprimierung

        console.log('Starte Bild-Upload:', fileName);

        // Bild hochladen
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('parts-images')
          .upload(fileName, compressedImage, {
            cacheControl: '3600',
            upsert: false,
            contentType: 'image/jpeg',
          });

        if (uploadError) {
          console.error('Upload-Fehler:', uploadError);
          throw new Error(`Fehler beim Hochladen des Bildes: ${uploadError.message}`);
        }

        console.log('Bild-Upload erfolgreich');

        // Bild-URL generieren
        const imageUrl = `https://yvdptnkmgfxkrszitweo.supabase.co/storage/v1/object/public/parts-images/${fileName}`;

        // Daten für Datenbank vorbereiten
        const insertData = {
          user_id: user.id,
          title: validatedData.title,
          description: validatedData.description,
          price: validatedData.price,
          condition: validatedData.condition,
          contact_number: userPhone,
          image_url: imageUrl,
          type: validatedData.type,
          created_at: new Date().toISOString()
        };

        console.log('Starte Datenbank-Insert');

        // Teil in Datenbank speichern
        const { data: result, error: insertError } = await supabase
          .from('parts')
          .insert([insertData])
          .select();

        if (insertError) {
          console.error('Insert-Fehler:', insertError);
          
          // Aufräumen: Hochgeladenes Bild löschen
          try {
            await supabase.storage
              .from('parts-images')
              .remove([fileName]);
          } catch (cleanupError) {
            console.error('Cleanup-Fehler:', cleanupError);
          }
          
          throw new Error(`Fehler beim Speichern: ${insertError.message}`);
        }

        console.log('Teil erfolgreich gespeichert');

        // Tracking
        await trackEvent('teil_hinzugefuegt', {
          title: validatedData.title,
          price: validatedData.price,
          condition: validatedData.condition,
          type: validatedData.type,
          original_size: validatedData.imageFile.size,
          compressed_size: compressedImage.size,
          success: true
        });

        // Erfolgsmeldung und Formular zurücksetzen
        showLoading(false);
        showSuccess("Teil erfolgreich hinzugefügt! Du wirst zur Startseite weitergeleitet...");
        resetForm();

        // Weiterleitung zur Startseite
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);

      } catch (error) {
        console.error('Fehler beim Hinzufügen des Teils:', error);
        showLoading(false);
        showError(error.message || 'Ein unerwarteter Fehler ist aufgetreten. Bitte versuche es erneut.');
        
        // Tracking für Fehler
        await trackEvent('teil_hinzufuegen_fehler', {
          error: error.message,
          success: false
        });
        
      } finally {
        isProcessing = false;
        
        // Button wieder aktivieren
        if (button) {
          button.disabled = false;
          button.textContent = 'Teil hinzufügen';
        }
        showLoading(false);
      }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM geladen, initialisiere App...');
      
      // Supabase initialisieren
      if (!initializeSupabase()) {
        return;
      }

      // Telefonnummer laden
      loadPhoneNumber();

      // Button Event Listener
      const addButton = document.getElementById('addPartBtn');
      if (addButton) {
        addButton.addEventListener('click', addPart);
      }

      // File Input Event Listener für besseres Feedback
      const fileInput = document.getElementById('partImage');
      if (fileInput) {
        fileInput.addEventListener('change', function(e) {
          const file = e.target.files?.[0];
          if (file) {
            console.log('Datei ausgewählt:', {
              name: file.name,
              size: file.size,
              type: file.type
            });
            
            // Sofortige Validierung
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
              showError('Das ausgewählte Bild ist zu groß (max. 10MB).');
              e.target.value = '';
              return;
            }
            
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type.toLowerCase())) {
              showError('Nur Bilddateien (JPEG, PNG, GIF, WebP) sind erlaubt.');
              e.target.value = '';
              return;
            }
            
            hideMessages();
          }
        });
      }

      // Formular-Validierung bei Eingabe
      const inputs = ['partTitle', 'partDescription', 'partPrice'];
      inputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', hideMessages);
        }
      });

      console.log('App erfolgreich initialisiert');
    });

    // Globale Fehlerbehandlung
    window.addEventListener('error', function(e) {
      console.error('Globaler Fehler:', e.error);
      showError('Ein unerwarteter Fehler ist aufgetreten. Bitte lade die Seite neu.');
    });

    // Unhandled Promise Rejections
    window.addEventListener('unhandledrejection', function(e) {
      console.error('Unbehandelte Promise-Ablehnung:', e.reason);
      showError('Ein Netzwerkfehler ist aufgetreten. Bitte versuche es erneut.');
    });
  </script>
</body>
</html>