<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TuningHub</title>
    <link rel="stylesheet" href="css/index.css" />
    <link rel="stylesheet" href="css/search.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
   
</head>

<body>
    <!-- Header mit Logo & Account -->
    <header class="header">
        <div class="header-top">
            <div class="logo">
                <a href="index.html">
                    <img src="img/THub-Logo-ohne-Hintergrund-500x200.png" alt="TuningHub Logo" height="50" />
                </a>
            </div>
            <div class="account-erstellen">
                <a id="account-link" href="#">
                    <img src="img/account-icon-schwarz.svg" alt="Account" width="36" height="36" />
                </a>
            </div>
        </div>
        
        <!-- Suchleiste -->
        <div class="searchbar-wrapper">
            <input type="text" class="searchbar" placeholder="Suche nach Teilen, Marken..." />
        </div>
    </header>

    <!-- Hauptinhalt -->
    <main>
  <div class="link-bar">
    <a class="left" href="teilehinzuf√ºgen.html">Hinzuf√ºgen</a>
    <a class="right" href="teile.html">Alle ansehen &rarr;</a>
  </div>

  <!-- Container f√ºr dynamische Karten -->
  <div class="grid-container" id="angebot-container">
    <!-- Dynamische Karten werden hier eingef√ºgt -->
  </div>
</main>

    <!-- Detailansicht Modal -->
    <div class="detail-modal" id="detail-modal">
        <div class="detail-content">
            <div class="detail-header">
                <h1 class="detail-title" id="detail-title">Titel</h1>
                <button class="close-button" id="close-detail">&times;</button>
            </div>
            <div class="detail-body">
                <div class="detail-image-section">
                    <img id="detail-image" class="detail-main-image" src="" alt="" />
                </div>
                <div class="detail-info-section">
                    <p class="detail-price" id="detail-price">0‚Ç¨</p>
                    <div class="detail-description" id="detail-description">
                        Keine Beschreibung verf√ºgbar.
                    </div>
                    <div class="detail-meta">
                        <div class="meta-item">
                            <span class="meta-label">Kategorie</span>
                            <span class="meta-value" id="detail-category">Tuning-Teil</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Zustand</span>
                            <span class="meta-value" id="detail-condition">Gebraucht</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Verk√§ufer</span>
                            <span class="meta-value" id="detail-seller">Kontakt √ºber Telefon</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Telefon</span>
                            <span class="meta-value" id="detail-phone">Wird beim Kontakt angezeigt</span>
                        </div>
                    </div>
                    <div class="detail-actions">
                        <button class="action-button primary-button" id="contact-seller-btn">Verk√§ufer kontaktieren</button>
                        <button class="action-button secondary-button" id="share-btn">Teilen</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="informations"><a href="√ºbertuninghub.html">TuningHub</a> </div>
        <div class="informations"><a href="impressum.html">Impressum</a></div>
        <div class="informations"> <a href="support.html"> Support</a></div>
        <div class="informations"> <a href="socialmedia.html"> Social Media</a></div>
        <div class="informations"><a href="datenschutz.html">Datenschutz</a></div>
    </footer>

    <!-- √úberarbeitetes JavaScript -->
    <script src="js/search.js"></script>
    <script>
        // Debug-Funktionen
        function log(message, data = null) {
            console.log(`[TuningHub] ${message}`, data || '');
        }

        function showError(message) {
            const container = document.getElementById('angebot-container');
            container.innerHTML = `<div class="error">‚ùå ${message}</div>`;
            log(`ERROR: ${message}`);
        }

        function showLoading() {
            const container = document.getElementById('angebot-container');
            container.innerHTML = '<div class="loading">üîÑ Lade Angebote...</div>';
        }

        function showEmpty() {
            const container = document.getElementById('angebot-container');
            container.innerHTML = '<div class="empty">üì¶ Keine Angebote vorhanden</div>';
        }

        // Supabase Setup
        const supabaseUrl = 'https://yvdptnkmgfxkrszitweo.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2ZHB0bmttZ2Z4a3Jzeml0d2VvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3MDAwMzQsImV4cCI6MjA2NjI3NjAzNH0.Kd6D6IQ_stUMrcbm2TN-7ACjFJvXNmkeNehQHavTmJo';
        
        let supabase;
        
        try {
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
            log('Supabase Client erfolgreich erstellt');
        } catch (error) {
            log('Fehler beim Erstellen des Supabase Clients:', error);
            showError('Fehler beim Verbinden mit der Datenbank');
        }

        // Sichere Datenextraktion
        function extractData(teil) {
            // Alle m√∂glichen Feldnamen pr√ºfen
            const name = teil.name || teil.title || teil.bezeichnung || teil.teil_name || 'Unbekanntes Teil';
            const preis = teil.preis || teil.price || teil.kosten || teil.euro || 'Preis auf Anfrage';
            const beschreibung = teil.beschreibung || teil.description || teil.details || '';
            const bild = teil.bild_url || teil.image_url || teil.foto || teil.bild || null;
            const kategorie = teil.kategorie || teil.category || teil.type || 'Tuning-Teil';
            const zustand = teil.zustand || teil.condition || teil.state || 'Gebraucht';
            const telefon = teil.contact_number || teil.phone || teil.telefon || '';
            const verk√§ufer = teil.seller_name || teil.user_name || 'Privater Verk√§ufer';
            const datum = teil.created_at || teil.date || new Date().toISOString();
            const id = teil.id;
            
            return { name, preis, beschreibung, bild, kategorie, zustand, telefon, verk√§ufer, datum, id };
        }

        // Verk√§ufer kontaktieren
        function contactSeller(telefon) {
            if (!telefon) {
                alert('Keine Telefonnummer verf√ºgbar');
                return;
            }
            
            // Telefonnummer bereinigen (nur Zahlen und +)
            const cleanedPhone = telefon.replace(/[^\d+]/g, '');
            
            // Verschiedene Optionen anbieten
            const options = [
                `üìû Anrufen: ${telefon}`,
                `üí¨ WhatsApp: ${telefon}`,
                `üì± SMS: ${telefon}`,
                '‚ùå Abbrechen'
            ];
            
            const choice = prompt(
                `Wie m√∂chtest du den Verk√§ufer kontaktieren?\n\n` +
                `1 - ${options[0]}\n` +
                `2 - ${options[1]}\n` +
                `3 - ${options[2]}\n` +
                `4 - ${options[3]}\n\n` +
                `Telefonnummer: ${telefon}\n\n` +
                `Gib die Nummer 1-4 ein:`,
                '1'
            );
            
            switch(choice) {
                case '1':
                    window.location.href = `tel:${cleanedPhone}`;
                    break;
                case '2':
                    window.open(`https://wa.me/${cleanedPhone.replace(/[^\d]/g, '')}`, '_blank');
                    break;
                case '3':
                    window.location.href = `sms:${cleanedPhone}`;
                    break;
                case '4':
                case null:
                    // Abbrechen
                    break;
                default:
                    alert('Ung√ºltige Auswahl');
            }
        }

        // Teil teilen Funktion
        function sharePart(id) {
            if (!id) {
                alert('Fehler: Teil-ID nicht verf√ºgbar');
                return;
            }

            // Link zu index.html mit part parameter
            const url = `${window.location.origin}/index.html?part=${encodeURIComponent(id)}`;

            if (navigator.share) {
                navigator.share({
                    title: 'Tuning-Teil bei TuningHub',
                    text: 'Schau dir dieses Teil bei TuningHub an!',
                    url: url,
                }).catch(err => console.warn('Sharing failed:', err));
            } else {
                // Check if clipboard API is available
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(url)
                        .then(() => alert("Link zum Teil wurde in die Zwischenablage kopiert!"))
                        .catch(err => {
                            console.error("Fehler beim Kopieren des Links:", err);
                            fallbackCopyToClipboard(url);
                        });
                } else {
                    // Fallback method for older browsers or non-HTTPS contexts
                    fallbackCopyToClipboard(url);
                }
            }
        }

        // Fallback function for copying to clipboard
        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert("Link zum Teil wurde in die Zwischenablage kopiert!");
                } else {
                    showLinkDialog(text);
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                showLinkDialog(text);
            } finally {
                document.body.removeChild(textArea);
            }
        }

        // Show link in a dialog if all copy methods fail
        function showLinkDialog(url) {
            const message = `Link konnte nicht automatisch kopiert werden. Bitte kopiere den Link manuell:\n\n${url}`;
            alert(message);
        }

        // Globale Variable f√ºr aktuelles Teil
        let currentPart = null;

        // Detailansicht √∂ffnen
        function openDetailView(teil) {
            const modal = document.getElementById('detail-modal');
            const { name, preis, beschreibung, bild, kategorie, zustand, telefon, verk√§ufer, datum, id } = extractData(teil);
            
            // Aktuelles Teil speichern
            currentPart = teil;
            
            // Titel setzen
            document.getElementById('detail-title').textContent = name;
            
            // Bild setzen
            const imageUrl = bild || 'https://via.placeholder.com/600x400/e9ecef/666?text=Kein+Bild';
            const fallbackUrl = 'https://via.placeholder.com/600x400/f8f9fa/adb5bd?text=Bild+nicht+verf√ºgbar';
            const detailImage = document.getElementById('detail-image');
            detailImage.src = imageUrl;
            detailImage.alt = name;
            detailImage.onerror = function() { this.src = fallbackUrl; };
            
            // Preis formatieren und setzen
            let preisText = preis;
            if (typeof preis === 'number') {
                preisText = `${preis.toLocaleString('de-DE')}‚Ç¨`;
            } else if (typeof preis === 'string' && !isNaN(parseFloat(preis))) {
                preisText = `${parseFloat(preis).toLocaleString('de-DE')}‚Ç¨`;
            }
            document.getElementById('detail-price').textContent = preisText;
            
            // Beschreibung setzen
            document.getElementById('detail-description').textContent = 
                beschreibung || 'Keine detaillierte Beschreibung verf√ºgbar.';
            
            // Meta-Informationen setzen
            document.getElementById('detail-category').textContent = kategorie;
            document.getElementById('detail-condition').textContent = zustand;
            document.getElementById('detail-seller').textContent = verk√§ufer;
            document.getElementById('detail-phone').textContent = telefon || 'Nicht verf√ºgbar';
            
            // Kontakt-Button Event
            const contactBtn = document.getElementById('contact-seller-btn');
            contactBtn.onclick = function() {
                contactSeller(telefon);
            };
            
            // Button deaktivieren wenn keine Telefonnummer
            if (!telefon) {
                contactBtn.disabled = true;
                contactBtn.textContent = 'Keine Kontaktdaten verf√ºgbar';
            } else {
                contactBtn.disabled = false;
                contactBtn.textContent = 'Verk√§ufer kontaktieren';
            }
            
            // Teilen-Button Event
            const shareBtn = document.getElementById('share-btn');
            shareBtn.onclick = function() {
                sharePart(id);
            };
            
            // Modal anzeigen
            modal.classList.add('active');
            document.body.style.overflow = 'hidden'; // Scrollen verhindern
            
            log('Detailansicht ge√∂ffnet f√ºr:', name);
        }

        // Detailansicht schlie√üen
        function closeDetailView() {
            const modal = document.getElementById('detail-modal');
            modal.classList.remove('active');
            document.body.style.overflow = ''; // Scrollen wieder erlauben
            currentPart = null;
            log('Detailansicht geschlossen');
        }

        // Karte erstellen
        function createCard(teil) {
            const { name, preis, beschreibung, bild } = extractData(teil);
            
            const card = document.createElement('div');
            card.className = 'card';
            
            // Bild-URL mit Fallback
            const imageUrl = bild || 'https://via.placeholder.com/300x200/e9ecef/666?text=Kein+Bild';
            const fallbackUrl = 'https://via.placeholder.com/300x200/f8f9fa/adb5bd?text=Bild+nicht+verf√ºgbar';
            
            // Preis formatieren
            let preisText = preis;
            if (typeof preis === 'number') {
                preisText = `${preis.toLocaleString('de-DE')}‚Ç¨`;
            } else if (typeof preis === 'string' && !isNaN(parseFloat(preis))) {
                preisText = `${parseFloat(preis).toLocaleString('de-DE')}‚Ç¨`;
            }
            
            card.innerHTML = `
                <img src="${imageUrl}" 
                     alt="${name}" 
                     onerror="this.src='${fallbackUrl}'" 
                     loading="lazy" />
                <h2>${name}</h2>
                ${beschreibung ? `<p>${beschreibung}</p>` : ''}
                <p><strong>${preisText}</strong></p>
            `;
            
            // Click-Event f√ºr Detailansicht
            card.addEventListener('click', function() {
                openDetailView(teil);
            });
            
            return card;
        }

        // Hauptfunktion zum Laden der Angebote
        async function ladeAngebote() {
            log('Starte Laden der Angebote...');
            
            const container = document.getElementById('angebot-container');
            if (!container) {
                log('ERROR: Container nicht gefunden');
                return;
            }

            if (!supabase) {
                showError('Supabase nicht initialisiert');
                return;
            }

            showLoading();

            try {
                log('Lade Daten aus Supabase...');
                
                const { data, error } = await supabase
                    .from('parts')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(20);

                if (error) {
                    log('Supabase Fehler:', error);
                    showError(`Datenbankfehler: ${error.message}`);
                    return;
                }

                log('Daten erfolgreich geladen:', data);
                
                if (!data || data.length === 0) {
                    showEmpty();
                    return;
                }

                // Container leeren
                container.innerHTML = '';

                // Jedes Teil verarbeiten
                data.forEach((teil, index) => {
                    log(`Verarbeite Teil ${index + 1}:`, teil);
                    
                    try {
                        const card = createCard(teil);
                        container.appendChild(card);
                    } catch (cardError) {
                        log(`Fehler beim Erstellen der Karte ${index + 1}:`, cardError);
                    }
                });

                log(`‚úÖ ${data.length} Teile erfolgreich angezeigt`);

            } catch (error) {
                log('Unerwarteter Fehler:', error);
                showError(`Unerwarteter Fehler: ${error.message}`);
            }
        }

        // Account-Link setzen
        async function setAccountLink() {
            if (!supabase) return;
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                const accountLink = document.getElementById('account-link');
                if (accountLink) {
                    accountLink.href = user ? 'account.html' : 'login.html';
                    log('Account-Link gesetzt:', user ? 'Eingeloggt' : 'Nicht eingeloggt');
                }
            } catch (error) {
                log('Fehler beim Setzen des Account-Links:', error);
            }
        }

        // Suchfunktion
        function setupSearch() {
            const searchInput = document.querySelector('.searchbar');
            if (!searchInput) return;
            
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase();
                log('Suche:', query);
                
                // Hier k√∂nnte eine Suchfunktion implementiert werden
                // F√ºr jetzt nur ein Log
            });
        }

        // Test-Daten anzeigen (falls keine echten Daten da sind)
        function showTestData() {
            log('Zeige Test-Daten...');
            
            const container = document.getElementById('angebot-container');
            const testData = [
                {
                    id: 'test-1',
                    name: 'BMW M3 Spoiler',
                    preis: 299,
                    beschreibung: 'Originaler BMW M3 Spoiler in sehr gutem Zustand. Perfekt f√ºr alle E46 Modelle.',
                    bild_url: 'https://via.placeholder.com/300x200/007bff/white?text=BMW+M3+Spoiler',
                    kategorie: 'Karosserie',
                    zustand: 'Sehr gut',
                    contact_number: '+49 123 456789',
                    seller_name: 'Max Mustermann',
                    created_at: '2024-01-15T10:30:00Z'
                },
                {
                    id: 'test-2',
                    name: 'Audi RS4 Felgen',
                    preis: 1200,
                    beschreibung: '19 Zoll Originalfelgen vom Audi RS4, wie neu, ohne Kratzer oder Besch√§digungen.',
                    bild_url: 'https://via.placeholder.com/300x200/28a745/white?text=Audi+RS4+Felgen',
                    kategorie: 'Felgen',
                    zustand: 'Neuwertig',
                    contact_number: '+49 987 654321',
                    seller_name: 'Anna Schmidt',
                    created_at: '2024-01-10T14:20:00Z'
                },
                {
                    id: 'test-3',
                    name: 'Turbolader Kit',
                    preis: 2500,
                    beschreibung: 'Komplettes Turbolader-Kit f√ºr VW Golf GTI, inklusive aller Montageteile.',
                    bild_url: 'https://via.placeholder.com/300x200/dc3545/white?text=Turbolader+Kit',
                    kategorie: 'Motor',
                    zustand: 'Gebraucht',
                    contact_number: '+49 555 123456',
                    seller_name: 'Thomas M√ºller',
                    created_at: '2024-01-08T09:15:00Z'
                }
            ];
            
            container.innerHTML = '';
            testData.forEach(teil => {
                const card = createCard(teil);
                container.appendChild(card);
            });
        }

        // Event-Listener f√ºr Detailansicht
        function setupDetailView() {
            // Schlie√üen-Button
            document.getElementById('close-detail').addEventListener('click', closeDetailView);
            
            // Au√üerhalb des Modals klicken
            document.getElementById('detail-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeDetailView();
                }
            });
            
            // ESC-Taste
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeDetailView();
                }
            });
            
            log('Detailansicht Event-Listener eingerichtet');
        }

        // Handle shared part links
        function handleSharedPartLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const partId = urlParams.get('part');
            
            if (partId) {
                log('Shared part ID detected:', partId);
                
                // Wait for the parts to load, then find and open the specific part
                setTimeout(async () => {
                    try {
                        const { data: part, error } = await supabase
                            .from('parts')
                            .select('*')
                            .eq('id', partId)
                            .single();
                        
                        if (error) {
                            log('Error loading shared part:', error);
                            alert('Das geteilte Teil konnte nicht gefunden werden.');
                            return;
                        }
                        
                        if (part) {
                            log('Opening shared part:', part);
                            openDetailView(part);
                        } else {
                            alert('Das geteilte Teil existiert nicht mehr.');
                        }
                    } catch (error) {
                        log('Error handling shared part:', error);
                        alert('Fehler beim Laden des geteilten Teils.');
                    }
                }, 1000); // Wait 1 second for other initialization to complete
            }
        }

        // Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            log('DOM geladen, starte Initialisierung...');
            
            // Account-Link setzen
            setAccountLink();
            
            // Suchfunktion einrichten
            setupSearch();
            
            // Detailansicht einrichten
            setupDetailView();
            
            // Angebote laden
            ladeAngebote().catch(error => {
                log('Fallback: Zeige Test-Daten wegen Fehler:', error);
                showTestData();
            });
            
            // Handle shared part links
            handleSharedPartLink();
        });

        // Fehler-Handler f√ºr unbehandelte Fehler
        window.addEventListener('error', function(e) {
            log('Globaler Fehler:', e.error);
        });
    </script>
</body>
</html>